<!DOCTYPE html>
<html>
<head>
    <title>MilestoneBurnupChart</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define('CustomApp', {
	extend : 'Rally.app.App',
	componentCls : 'app',

	getSettingsFields : function() {
		return [ {
			name : 'IncludeNullTargetProjMilestone',
			xtype : 'rallycheckboxfield',
			fieldLabel : '',
			boxLabel : 'Include Milestones with All Projects in Research and Development Workspace'
		} ];
	},

	launch : function() {
		this._createMilestoneWaspiDataStore();
	},

	/**
	 * Create the WASPI Data Store for Milestone
	 */
	_createMilestoneWaspiDataStore : function() {
		Ext.getBody().mask('Loading...');
		console.log("Rally.environment.getContext().getProject()._ref : ", Rally.environment.getContext().getProject()._ref);

		// Create filter based on settings selection
		var filter;
		if (this.getSetting('IncludeNullTargetProjMilestone')) {
			var projFilter = Ext.create('Rally.data.wsapi.Filter', {
				property : 'TargetProject',
				operator : '=',
				value : Rally.environment.getContext().getProject()._ref
			});
			filter = projFilter.or(Ext.create('Rally.data.wsapi.Filter', {
				property : 'TargetProject',
				operator : '=',
				value : null
			}));
		} else {
			filter = Ext.create('Rally.data.wsapi.Filter', {
				property : 'TargetProject',
				operator : '=',
				value : Rally.environment.getContext().getProject()._ref
			});
		}

		milestoneWaspiDataStore = Ext.create('Rally.data.wsapi.Store', {
			model : 'Milestone',
			autoLoad : true,
			compact : false,
			context : {
				workspace : Rally.environment.getContext().getWorkspace()._ref,
				project : Rally.environment.getContext().getProject()._ref,
				projectScopeUp : false,
				projectScopeDown : true
			},
			filters : filter,
			fetch : [ 'ObjectID', 'FormattedID', 'Name', 'TargetDate', 'TargetProject' ],
			limit : Infinity,
			listeners : {
				load : function(store, data, success) {
					if (data.length > 0) {
						this._createMilestoneDataStore(data);
					} else {
						// Ext.Msg.alert('Warning', 'No Milestone is associated
						// with the selected Project.');
						Rally.ui.notify.Notifier.showError({
							message : 'No Milestone is associated with the selected Project.'
						});
					}
					Ext.getBody().unmask();
				},
				scope : this
			},
			sorters : [ {
				property : 'Name',
				direction : 'ASC'
			} ]
		});
	},

	/**
	 * Convert the WASPI Data Store for Milestone to Ext.data.Store
	 */
	_createMilestoneDataStore : function(myData) {

		var milestoneArr = [];

		Ext.each(myData, function(data, index) {
			var milestone = {};
			milestone.ObjectID = data.data.ObjectID;
			milestone.FormattedID = data.data.FormattedID;
			milestone.Name = data.data.Name;
			milestone.TargetDate = data.data.TargetDate;
			milestone.TargetProject = data.data.TargetProject;
			milestoneArr.push(milestone);
		});

		this.milestoneDataStore = Ext.create('Ext.data.Store', {
			fields : [ 'ObjectID', 'FormattedID', 'Name', 'TargetDate', 'TargetProject' ],
			data : milestoneArr
		});
		this._createMilestonePicker();
	},

	/**
	 * Create the Ext.form.ComboBox for the Milestone
	 */
	_createMilestonePicker : function() {
		this.milestonePicker = Ext.create('Ext.form.ComboBox', {
			fieldLabel : 'Milestone ',
			store : this.milestoneDataStore,
			renderTo : Ext.getBody(),
			displayField : 'Name',
			queryMode : 'local',
			valueField : 'ObjectID',
			border : 1,
			style : {
				borderColor : '#000000',
				borderStyle : 'solid',
				borderWidth : '1px',
				height : '40px'
			},
			width : 400,
			padding : '10 5 5 10',
			margin : '10 5 5 10',
			shadow : 'frame',
			labelAlign : 'right',
			labelStyle : {
				margin : '10 5 5 10'
			},
			listeners : {
				select : function(combo, records, eOpts) {
					console.log("Selected Milestone : ", combo.getValue());
					this.selectedMilestone = combo.getValue();
					this._drawBurnUpChart();
				},
				scope : this
			}
		});
		this.add(this.milestonePicker);
	},

	/**
	 * Create the burnup chart and draw it
	 */
	_drawBurnUpChart : function() {
		Ext.getBody().mask('Generating Burnup Chart...');

		Deft.Promise.all([ this._loadPIsInMilestone(), this._loadScheduleStateValues() ]).then({
			success : function() {
				this._addChart();
			},
			scope : this
		});
	},

	_loadScheduleStateValues : function() {
		return Rally.data.ModelFactory.getModel({
			type : 'UserStory',
			success : function(model) {
				model.getField('ScheduleState').getAllowedValueStore().load({
					callback : function(records) {
						this.scheduleStateValues = _.invoke(records, 'get', 'StringValue');
					},
					scope : this
				});
			},
			scope : this
		});
	},

	_loadPIsInMilestone : function() {
		var that = this;
		return Ext.create('Rally.data.wsapi.Store', {
			model : 'TypeDefinition',
			autoLoad : true,
			fetch : [ 'TypePath' ],
			filters : [ {
				property : 'Parent.Name',
				value : 'Portfolio Item'
			}, {
				property : 'Ordinal',
				value : 0
			} ]
		}).load().then({
			success : function(records) {
				this.piType = records[0].get('TypePath');
				return Ext.create('Rally.data.wsapi.Store', {
					model : this.piType,
					fetch : [ 'ObjectID', 'Project', 'Name', 'PreliminaryEstimate', 'ActualStartDate', 'PlannedEndDate', 'AcceptedLeafStoryPlanEstimateTotal', 'LeafStoryPlanEstimateTotal' ],
					filters : [ {
						property : 'Milestones.ObjectID',
						operator : '=',
						value : this.selectedMilestone
					} ],
					context : {
						project : null
					},
					limit : Infinity
				}).load().then({
					success : function(piRecords) {
						this.piRecords = piRecords;
					},
					scope : this
				});
			},
			scope : this
		});
	},

	_addChart : function() {
		var that = this;

		if (that.down('rallychart')) {
			that.down('rallychart').destroy();
		}

		console.log("_.min(_.compact(_.invoke(that.piRecords, 'get', 'ActualStartDate')))", _.min(_.compact(_.invoke(that.piRecords, 'get', 'ActualStartDate'))));
		console.log("that.piRecords",that.piRecords);
		this.add({
			xtype : 'rallychart',
			flex : 1,
			storeType : 'Rally.data.lookback.SnapshotStore',
			storeConfig : that._getStoreConfig(),
			calculatorType : 'Rally.example.BurnCalculator',
			calculatorConfig : {
				completedScheduleStateNames : [ 'Accepted', 'Released' ],
				stateFieldValues : that.scheduleStateValues,
				startDate : _.min(_.compact(_.invoke(that.piRecords, 'get', 'ActualStartDate'))),
				enableProjects : true
			},
			chartColors: ["#A16E3A", "#1B7F25", "#B1B1B7", "#2E2EAC"],
			chartConfig : that._getChartConfig(),
			listeners : {
				afterrender : function(obj, eOpts ) {					
					Ext.getBody().unmask();
				},
				scope : this
			}
		});
		//Ext.getBody().unmask();
	},

	/**
	 * Generate the store config to retrieve all snapshots for all leaf child
	 * stories of the specified PI
	 */
	_getStoreConfig : function() {
		return {
			find : {
				_TypeHierarchy : {
					'$in' : [ 'HierarchicalRequirement' ]
				},
				_ItemHierarchy : {
					'$in' : _.invoke(this.piRecords, 'getId')
				}
			},
			fetch : [ 'ScheduleState', 'PlanEstimate' ],
			hydrate : [ 'ScheduleState' ],
			sort : {
				_ValidFrom : 1
			},
			context : this.getContext().getDataContext(),
			limit : Infinity
		};
	},

	/**
	 * Generate a valid Highcharts configuration object to specify the chart
	 */

	_getChartConfig : function() {
		return {
			chart : {
				defaultSeriesType : 'area',
				zoomType : 'xy'
			},
			title : {
				text : 'Milestone Burnup'
			},
			xAxis : {
				categories : [],
				tickmarkPlacement : 'on',
				tickInterval : 5,
				title : {
					text : 'Date',
					margin : 10
				}
			},
			yAxis : [ {
				title : {
					text : 'Counts'
				}
			} ],
			tooltip : {
				formatter : function() {
					return '' + this.x + '<br />' + this.series.name + ': ' + Math.ceil(this.y);
				}
			},
			plotOptions : {
				series : {
					marker : {
						enabled : false,
						states : {
							hover : {
								enabled : true
							}
						}
					},
					groupPadding : 0.01
				},
				column : {
					stacking : null,
					shadow : false
				}
			}
		};
	}

});
                Ext.define('Rally.example.BurnCalculator', {
	extend : 'Rally.data.lookback.calculator.TimeSeriesCalculator',
	config : {
		completedScheduleStateNames : [ 'Accepted' ]
	},

	constructor : function(config) {
		this.initConfig(config);
		this.callParent(arguments);
	},

	getDerivedFieldsOnInput : function() {
		var completedScheduleStateNames = this.getCompletedScheduleStateNames();
		return [ {
			"as" : "StoryCount",
			"f" : function(snapshot) {
				return 1;
			}
		}, {
			"as" : "CompletedStoryCount",
			"f" : function(snapshot) {
				var ss = snapshot.ScheduleState;
				if (completedScheduleStateNames.indexOf(ss) > -1) {
					return 1;
				} else {
					return 0;
				}
			}
		} ];
	},

	getDerivedFieldsAfterSummary : function() {
		var stateFieldValues = this.stateFieldValues;
		return [ {
			as : 'Ideal',
			f : function(row, index, summaryMetrics, seriesData) {
				var data = _.last(seriesData), max = seriesData[seriesData.length-1].Planned, increments = seriesData.length - 1, incrementAmount;
				if (increments === 0) {
					return max;
				}
				incrementAmount = max / increments;
				return Math.floor(100 * (index * incrementAmount)) / 100;
			},
			display : 'line'
		}, {
			as : 'Actual',
			f : function(row, index, summaryMetrics, seriesData) {
				var today = Rally.util.DateTime.toIsoString(new Date());
				var endIndex = seriesData.length-1;
				/*var endIndex = _.findIndex(seriesData, function(data) {
					console.log("data.tick", data.tick);
					return data.tick > today;
				});*/
				if (index <= endIndex) {
					var acceptedSeriesData = _.pluck(seriesData, 'Completed');
					var slope = (acceptedSeriesData[0] - acceptedSeriesData[endIndex]) / (0 - endIndex);
					return index * slope;
				}
			},
			display : 'line'
		} ];
	},

	getMetrics : function() {
		return [ {
			"field" : "StoryCount",
			"as" : "Planned",
			"display" : "line",
			"f" : "sum"
		}, {
			"field" : "CompletedStoryCount",
			"as" : "Completed",
			"f" : "sum",
			"display" : "column"
		} ];
	}
});


            Rally.launchApp('CustomApp', {
                name:"MilestoneBurnupChart",
	            parentRepos:""
            });

        });
    </script>



    <style type="text/css">
        .app {
  /* Add app styles here */
}

    </style>
</head>
<body>
</body>
</html>
